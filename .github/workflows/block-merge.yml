name: Block WIP/Draft Merges

on:
  workflow_call:
    inputs:
      block_labels:
        description: 'Comma-separated list of labels that block merging'
        required: false
        type: string
        default: 'do-not-merge'
      block_keywords:
        description: 'Comma-separated list of keywords in title that block merging'
        required: false
        type: string
        default: 'wip,do not merge'

jobs:
  block-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR should be blocked
        uses: actions/github-script@v7
        with:
          script: |
            const isDraft = context.payload.pull_request.draft;
            const title = context.payload.pull_request.title;
            const labels = context.payload.pull_request.labels.map(l => l.name);

            const blockLabels = '${{ inputs.block_labels }}'.split(',').map(s => s.trim());
            const blockKeywords = '${{ inputs.block_keywords }}'.split(',').map(s => s.trim());

            // Check if draft
            if (isDraft) {
              core.setFailed('❌ This PR is blocked from merging: Draft PR');
              return;
            }

            // Check labels
            for (const label of blockLabels) {
              if (labels.includes(label)) {
                core.setFailed(`❌ This PR is blocked from merging: "${label}" label`);
                return;
              }
            }

            // Check title keywords
            const lowerTitle = title.toLowerCase();
            for (const keyword of blockKeywords) {
              if (lowerTitle.includes(keyword.toLowerCase())) {
                core.setFailed(`❌ This PR is blocked from merging: "${keyword}" in title`);
                return;
              }
            }

            core.info('✅ PR is ready for merging');
